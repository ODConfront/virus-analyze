# av-kill

内存扫描的必要性：
不访问磁盘的病毒（W32/CodeRed、W32/Slammer、WinNT/RemEx）

1.引言
Tremor病毒在内容中活跃时，染毒程序的大小及内容保持与未染毒时一致。

2.WindowsNT虚拟内存系统
多层访问

3.虚拟地址空间
“虚拟地址-物理地址”映射

4.用户模式的内存扫描
NtQuerySystemInformation()->ReadProcessMemory()->VirtualQueryEx()
4.1NtQuerySystemInformation()
4.2公共进程及特殊的系统权限
OpenProcessToken(Token_Adjust_Privileges)->LookupPrivilegeValue()->AdjustTokenPrivileges()
4.3Win32子系统中的病毒
Csrss.exe(环境子系统程序)、内核模式设备驱动程序Win32k.sys和子系统DLL(user32.dll、advapi32.dll、gdi32.dll和kernel32.dll)
4.4分配私有页面的Win32病毒：W32/Cabanas.3014.A、W32/Parvo.13857
4.5原生的WindowsNT服务病毒：WNT/RemEx
4.6使用隐藏窗口过程的Win32病毒：{W32,W97M}/Beast.41472.A
4.7被执行并映像自身包含的Win32病毒：W32/Heretic.1986.A、W32/Niko.5178

5.内存扫描和页面调度
枚举进程扫描

6.内存杀毒
6.1终止包含病毒代码的特定进程：自保护进程W32/Semisoft
6.2检测和终止病毒线程：W32/Niko
6.3修复活跃页面中的病毒代码：W32/Heretic、W32/Ska.A
6.4如何为已装入内存的DLL及运行中的应用程序杀毒

7.内核模式的内存扫描
7.1扫描进程的用户地址空间
7.2确定NT服务API的入口点：KeServiceDescriptorTable+NtServiceID
7.3用于内核模式内存扫描的重要NT函数
NtQueryVirtualMemory()、NtTerminateProcess()、NtOpenThread()、NtSuspendThread()、NtResumeThread()、NtProcessVirtualMemory()
7.4进程上下文
PsLookupProcessByProcessId(pid)->KeAttachProcess(eprocess)->KeDetachProcess(eprocess)
7.5扫描地址空间上部的2GB
7.6如何使一个过滤驱动程序病毒失去活性
7.7对付只读型的内核内存
7.864位平台上内核模式的内存扫描

8.可能的内存扫描攻击

9.结论和下一步工作


